<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src https://*.supabase.co; img-src 'self' data:;">
  <title>Todo App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#f2f2f4;--card:#fff;--accent:#ff4d4d;--accent-hover:#e63946;
      --accent-gradient:linear-gradient(135deg,#ff4d4d,#ff6b6b);
      --text:#09090b;--text-muted:rgba(9,9,11,.5);--border:rgba(9,9,11,.1);
      --input-bg:#fff;--shadow:0 2px 8px rgba(0,0,0,.06);
      --shadow-hover:0 4px 16px rgba(0,0,0,.1);--radius:12px;
      --transition:.25s cubic-bezier(.4,0,.2,1);
    }
    [data-theme="dark"]{
      --bg:#09090b;--card:#111114;--text:#fafafa;--text-muted:rgba(255,255,255,.5);
      --border:rgba(255,255,255,.08);--input-bg:rgba(255,255,255,.04);
      --shadow:0 2px 8px rgba(0,0,0,.4);--shadow-hover:0 4px 16px rgba(255,77,77,.12);
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;justify-content:center;padding:40px 16px;transition:background var(--transition),color var(--transition)}
    .app{width:100%;max-width:600px}

    .header{text-align:center;margin-bottom:32px}
    .header h1{font-size:2rem;font-weight:700;margin-bottom:4px}
    .header h1 span{color:var(--accent)}
    .header p{color:var(--text-muted);font-size:.95rem}
    .header-row{display:flex;justify-content:center;align-items:center;position:relative;margin-bottom:4px}
    .btn-theme{position:absolute;right:0;background:var(--card);border:2px solid var(--border);border-radius:10px;width:42px;height:42px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition);box-shadow:var(--shadow)}
    .btn-theme:hover{border-color:var(--accent);box-shadow:var(--shadow-hover);transform:translateY(-1px)}
    .btn-theme svg{width:20px;height:20px;transition:transform .4s ease}
    .btn-theme:hover svg{transform:rotate(20deg)}
    .icon-sun,.icon-moon{display:none}
    [data-theme="light"] .icon-moon{display:block}
    [data-theme="dark"] .icon-sun{display:block}

    .input-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;display:flex;gap:12px;margin-bottom:24px;transition:box-shadow var(--transition),background var(--transition)}
    .input-card:focus-within{box-shadow:var(--shadow-hover)}
    .input-card input[type="text"]{flex:1;border:2px solid var(--border);border-radius:8px;padding:12px 16px;font-family:inherit;font-size:.95rem;color:var(--text);background:var(--input-bg);outline:none;transition:border-color var(--transition)}
    .input-card input[type="text"]::placeholder{color:var(--text-muted)}
    .input-card input[type="text"]:focus{border-color:var(--accent)}
    .btn-add{background:var(--accent-gradient);color:#fff;border:none;border-radius:8px;padding:12px 24px;font-family:inherit;font-size:.95rem;font-weight:600;cursor:pointer;white-space:nowrap;transition:transform var(--transition),box-shadow var(--transition)}
    .btn-add:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,77,77,.4)}

    .task-list{display:flex;flex-direction:column;gap:10px;margin-bottom:24px}

    .task-item{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);transition:box-shadow var(--transition),transform var(--transition),background var(--transition);animation:slideIn .3s ease-out}
    .task-item:hover{box-shadow:var(--shadow-hover);transform:translateY(-1px)}
    .task-item.removing{animation:slideOut .3s ease-in forwards}
    .task-item.completing{animation:pulse .3s ease}
    .task-row{display:flex;align-items:center;gap:12px;padding:14px 16px}

    .checkbox-wrapper{position:relative;width:22px;height:22px;flex-shrink:0}
    .checkbox-wrapper input{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer;z-index:1}
    .checkmark{position:absolute;top:0;left:0;width:22px;height:22px;border:2px solid var(--border);border-radius:6px;transition:all var(--transition);display:flex;align-items:center;justify-content:center}
    .checkmark svg{width:12px;height:12px;stroke:#fff;stroke-width:3;fill:none;stroke-linecap:round;stroke-linejoin:round;opacity:0;transform:scale(0);transition:all var(--transition)}
    .checkbox-wrapper input:checked+.checkmark{background:var(--accent);border-color:var(--accent)}
    .checkbox-wrapper input:checked+.checkmark svg{opacity:1;transform:scale(1)}

    .task-content{flex:1;min-width:0}
    .task-text{font-size:.95rem;line-height:1.4;word-break:break-word;transition:color var(--transition)}
    .task-item.completed .task-text{color:var(--text-muted);text-decoration:line-through}

    .task-actions{display:flex;align-items:center;gap:6px;flex-shrink:0}

    /* Due badge - couleurs bien visibles */
    .due-badge{display:inline-flex;align-items:center;gap:4px;font-size:.73rem;font-weight:600;padding:4px 10px;border-radius:20px;white-space:nowrap;cursor:default}
    .due-badge svg{width:11px;height:11px;flex-shrink:0}
    .due-badge.due-green{background:#d5f5e3;color:#1e8449;border:2px solid #2ecc71}
    .due-badge.due-yellow{background:#fdebd0;color:#b9770e;border:2px solid #f39c12}
    .due-badge.due-red{background:#fadbd8;color:#a93226;border:2px solid #e74c3c}
    .due-badge.overdue{animation:pulseBadge 1.8s ease-in-out infinite}
    .task-item.completed .due-badge{opacity:.35;animation:none}
    [data-theme="dark"] .due-badge.due-green{background:rgba(46,204,113,.3);color:#82e0aa;border-color:#2ecc71}
    [data-theme="dark"] .due-badge.due-yellow{background:rgba(243,156,18,.3);color:#f8c471;border-color:#f39c12}
    [data-theme="dark"] .due-badge.due-red{background:rgba(231,76,60,.3);color:#f1948a;border-color:#e74c3c}
    @keyframes pulseBadge{0%,100%{opacity:1}50%{opacity:.5}}

    /* Date input visible */
    .date-input{border:1.5px solid var(--border);border-radius:6px;padding:2px 6px;font-family:inherit;font-size:.72rem;color:var(--text);background:var(--input-bg);cursor:pointer;height:28px;outline:none;transition:border-color var(--transition),box-shadow var(--transition)}
    .date-input:hover,.date-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,109,90,.15)}
    .date-input::-webkit-calendar-picker-indicator{cursor:pointer;opacity:.7;transition:opacity .2s}
    .date-input:hover::-webkit-calendar-picker-indicator{opacity:1}
    [data-theme="dark"] .date-input{color-scheme:dark}
    [data-theme="dark"] .date-input::-webkit-calendar-picker-indicator{filter:invert(1)}

    .btn-action{background:none;border:none;cursor:pointer;padding:6px;border-radius:6px;color:var(--text-muted);display:inline-flex;align-items:center;justify-content:center;transition:color var(--transition),background var(--transition),opacity var(--transition);opacity:0;flex-shrink:0}
    .btn-action svg{width:18px;height:18px}
    .task-item:hover .btn-action{opacity:1}
    .btn-action.active{opacity:1;color:var(--accent)}
    .btn-action.btn-delete:hover{color:#e74c3c;background:rgba(231,76,60,.08)}
    .btn-action.btn-comment:hover{color:var(--accent);background:rgba(255,77,77,.1)}

    .comment-section{max-height:0;overflow:hidden;opacity:0;transition:max-height .3s ease,opacity .25s ease}
    .comment-section.open{max-height:200px;opacity:1}
    .comment-inner{padding:0 16px 14px 50px}
    .comment-section textarea{width:100%;border:2px solid var(--border);border-radius:8px;padding:10px 14px;font-family:inherit;font-size:.85rem;color:var(--text);background:var(--input-bg);outline:none;resize:vertical;min-height:60px;max-height:120px;transition:border-color var(--transition);line-height:1.5}
    .comment-section textarea::placeholder{color:var(--text-muted)}
    .comment-section textarea:focus{border-color:var(--accent)}

    .footer{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 20px;display:flex;justify-content:space-between;align-items:center;transition:background var(--transition)}
    .counter{font-size:.9rem;color:var(--text-muted);font-weight:500}
    .counter strong{color:var(--accent);font-weight:700}
    .btn-clear{background:none;border:1px solid var(--border);border-radius:8px;padding:8px 16px;font-family:inherit;font-size:.85rem;font-weight:500;color:var(--text-muted);cursor:pointer;transition:all var(--transition)}
    .btn-clear:hover{border-color:#e74c3c;color:#e74c3c}
    .footer-actions{display:flex;gap:8px;align-items:center}
    .btn-io{background:none;border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-family:inherit;font-size:.85rem;font-weight:500;color:var(--text-muted);cursor:pointer;transition:all var(--transition);display:inline-flex;align-items:center;gap:5px}
    .btn-io:hover{border-color:var(--accent);color:var(--accent)}
    .btn-io svg{width:14px;height:14px}
    .hidden-file{display:none}

    .empty-state{text-align:center;padding:48px 20px;color:var(--text-muted)}
    .empty-state svg{width:64px;height:64px;margin-bottom:16px;opacity:.3}

    .toast-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;pointer-events:none}
    .toast{background:var(--card);border:2px solid var(--accent);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);padding:14px 18px;display:flex;align-items:flex-start;gap:10px;min-width:280px;max-width:380px;pointer-events:auto;animation:toastIn .35s ease-out}
    .toast.removing{animation:toastOut .3s ease-in forwards}
    .toast-icon{flex-shrink:0;width:20px;height:20px;color:var(--accent)}
    .toast-body{flex:1}
    .toast-title{font-size:.85rem;font-weight:600;color:var(--text);margin-bottom:2px}
    .toast-msg{font-size:.8rem;color:var(--text-muted)}
    .toast-close{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:2px}

    /* Auth */
    .auth-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px 24px;margin-bottom:24px;transition:background var(--transition)}
    .auth-tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid var(--border)}
    .auth-tab{flex:1;padding:10px;font-family:inherit;font-size:.95rem;font-weight:600;background:none;border:none;color:var(--text-muted);cursor:pointer;transition:color var(--transition),border-color var(--transition);border-bottom:2px solid transparent;margin-bottom:-2px}
    .auth-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .auth-tab:hover{color:var(--text)}
    .auth-form{display:flex;flex-direction:column;gap:12px}
    .auth-form input{border:2px solid var(--border);border-radius:8px;padding:12px 16px;font-family:inherit;font-size:.95rem;color:var(--text);background:var(--input-bg);outline:none;transition:border-color var(--transition)}
    .auth-form input::placeholder{color:var(--text-muted)}
    .auth-form input:focus{border-color:var(--accent)}
    .btn-auth{background:var(--accent-gradient);color:#fff;border:none;border-radius:8px;padding:12px;font-family:inherit;font-size:.95rem;font-weight:600;cursor:pointer;transition:transform var(--transition),box-shadow var(--transition)}
    .btn-auth:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,77,77,.4)}
    .btn-auth:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
    .btn-skip{background:none;border:1px solid var(--border);border-radius:8px;padding:10px;font-family:inherit;font-size:.85rem;font-weight:500;color:var(--text-muted);cursor:pointer;transition:all var(--transition);margin-top:4px}
    .btn-skip:hover{border-color:var(--accent);color:var(--accent)}
    .auth-error{color:#e74c3c;font-size:.85rem;min-height:1.2em}
    .user-bar{display:flex;align-items:center;gap:10px;margin-bottom:4px}
    .user-email{font-size:.85rem;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .btn-logout{background:none;border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-family:inherit;font-size:.78rem;font-weight:500;color:var(--text-muted);cursor:pointer;transition:all var(--transition);white-space:nowrap}
    .btn-logout:hover{border-color:#e74c3c;color:#e74c3c}

    @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideOut{from{opacity:1;transform:translateX(0);max-height:300px}to{opacity:0;transform:translateX(30px);max-height:0;margin:0}}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
    @keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
    @keyframes toastOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(40px)}}

    @media(max-width:480px){
      body{padding:24px 12px}
      .header h1{font-size:1.6rem}
      .input-card{flex-direction:column}
      .btn-add{width:100%}
      .btn-action{opacity:1}
      .toast-container{left:12px;right:12px}
      .toast{min-width:auto}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  <div class="app">
    <div class="header">
      <div class="header-row">
        <h1>Mes <span>Tâches</span></h1>
        <button class="btn-theme" id="btnTheme" title="Changer de thème">
          <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
          <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
      </div>
      <p>Organisez votre journée simplement</p>
      <div class="user-bar" id="userBar" style="display:none">
        <span class="user-email" id="userEmail"></span>
        <button class="btn-logout" id="btnLogout">Déconnexion</button>
      </div>
    </div>
    <div class="auth-card" id="authSection">
      <div class="auth-tabs">
        <button class="auth-tab active" data-tab="login">Connexion</button>
        <button class="auth-tab" data-tab="signup">Inscription</button>
      </div>
      <form class="auth-form" id="authForm" autocomplete="on">
        <input type="email" id="authEmail" placeholder="Email" required autocomplete="email">
        <input type="password" id="authPassword" placeholder="Mot de passe" required minlength="6" autocomplete="current-password">
        <div class="auth-error" id="authError"></div>
        <button type="submit" class="btn-auth" id="btnAuth">Se connecter</button>
      </form>
      <button class="btn-skip" id="btnSkip">Continuer sans compte</button>
    </div>
    <div class="input-card" id="inputCard" style="display:none">
      <input type="text" id="taskInput" placeholder="Ajouter une nouvelle tâche..." autocomplete="off" maxlength="300">
      <button class="btn-add" id="btnAdd">Ajouter</button>
    </div>
    <div class="task-list" id="taskList" style="display:none"></div>
    <div class="footer" id="footer" style="display:none">
      <span class="counter" id="counter"></span>
      <div class="footer-actions">
        <button class="btn-io" id="btnExport" title="Exporter les tâches"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
        <button class="btn-io" id="btnImport" title="Importer des tâches"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></button>
        <input type="file" id="fileImport" class="hidden-file" accept=".json">
        <button class="btn-clear" id="btnClear">Effacer complétées</button>
      </div>
    </div>
  </div>
  <script>
    (function(){const s=localStorage.getItem('theme');document.documentElement.setAttribute('data-theme',s||'dark')})();

    // ── Supabase config ─────────────────────────────────────────
    const SUPABASE_URL = 'https://rxyldwgxetgyqdxawmen.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_ZPxvr6oqfpUH4W4BTk9jpg_4wbyhNbx';
    let _supabase = null;
    try {
      if (typeof supabase !== 'undefined' && SUPABASE_URL.indexOf('VOTRE_URL') === -1) {
        _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    } catch(e) { console.warn('Supabase CDN indisponible, mode hors-ligne'); }

    class TodoApp {
      constructor() {
        this.el = id => document.getElementById(id);
        this.clockSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
        this.user = null;
        this.authMode = 'login'; // 'login' or 'signup'
        this._commentTimers = {};

        // Boot from localStorage first (instant)
        this.tasks = this.loadLocal();
        this.bind();
        this.bindAuth();
        this.render();
        this.initReminders();
        setInterval(() => this.saveAllDates(), 2000);

        // Then check for existing Supabase session
        this.checkSession();
      }

      // ── Auth ────────────────────────────────────────────────────

      async checkSession() {
        if (!_supabase) return;
        try {
          const { data } = await _supabase.auth.getSession();
          if (data.session) {
            this.user = data.session.user;
            await this.loadFromSupabase();
            this.updateAuthUI();
            this.render();
          }
          // Listen for future auth changes
          _supabase.auth.onAuthStateChange((event, session) => {
            this.handleAuthChange(event, session);
          });
        } catch(e) { console.warn('Session check failed', e); }
      }

      handleAuthChange(event, session) {
        if (event === 'SIGNED_IN' && session) {
          this.user = session.user;
          this.updateAuthUI();
        } else if (event === 'SIGNED_OUT') {
          this.user = null;
          this.updateAuthUI();
        }
      }

      async signUp(email, password) {
        if (!_supabase) { this.showToast('Erreur', 'Supabase non configuré'); return; }
        const btn = this.el('btnAuth');
        btn.disabled = true;
        this.el('authError').textContent = '';
        try {
          const { data, error } = await _supabase.auth.signUp({ email, password });
          if (error) { this.el('authError').textContent = this.translateAuthError(error.message); return; }
          this.user = data.user;
          if (data.session) {
            await this.syncOnLogin();
            await this.loadFromSupabase();
          } else {
            this.showToast('Inscription réussie', 'Vérifiez votre email pour confirmer le compte');
            return;
          }
          this.updateAuthUI();
          this.render();
        } catch(e) {
          this.el('authError').textContent = 'Erreur réseau';
        } finally { btn.disabled = false; }
      }

      async signIn(email, password) {
        if (!_supabase) { this.showToast('Erreur', 'Supabase non configuré'); return; }
        const btn = this.el('btnAuth');
        btn.disabled = true;
        this.el('authError').textContent = '';
        try {
          const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
          if (error) { this.el('authError').textContent = this.translateAuthError(error.message); return; }
          this.user = data.user;
          await this.syncOnLogin();
          await this.loadFromSupabase();
          this.updateAuthUI();
          this.render();
        } catch(e) {
          this.el('authError').textContent = 'Erreur réseau';
        } finally { btn.disabled = false; }
      }

      async signOut() {
        if (_supabase) {
          try { await _supabase.auth.signOut(); } catch(e) {}
        }
        this.user = null;
        this.updateAuthUI();
      }

      updateAuthUI() {
        const auth = this.el('authSection');
        const bar = this.el('userBar');
        const app = this.el('inputCard');
        const list = this.el('taskList');
        const footer = this.el('footer');

        if (this.user || this._skipped) {
          auth.style.display = 'none';
          bar.style.display = this.user ? 'flex' : 'none';
          if (this.user) this.el('userEmail').textContent = this.user.email;
          app.style.display = 'flex';
          list.style.display = 'flex';
          // footer visibility managed by render()
        } else {
          auth.style.display = 'block';
          bar.style.display = 'none';
          app.style.display = 'none';
          list.style.display = 'none';
          footer.style.display = 'none';
        }
      }

      bindAuth() {
        // Tab switching
        this.el('authSection').querySelectorAll('.auth-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            this.el('authSection').querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            this.authMode = tab.dataset.tab === 'signup' ? 'signup' : 'login';
            this.el('btnAuth').textContent = this.authMode === 'signup' ? "S'inscrire" : 'Se connecter';
            this.el('authPassword').autocomplete = this.authMode === 'signup' ? 'new-password' : 'current-password';
            this.el('authError').textContent = '';
          });
        });

        // Form submit
        this.el('authForm').addEventListener('submit', e => {
          e.preventDefault();
          const email = this.el('authEmail').value.trim();
          const password = this.el('authPassword').value;
          if (!email || !password) return;
          if (this.authMode === 'signup') this.signUp(email, password);
          else this.signIn(email, password);
        });

        // Skip (continue without account)
        this.el('btnSkip').addEventListener('click', () => {
          this._skipped = true;
          this.updateAuthUI();
          this.render();
        });

        // Logout
        this.el('btnLogout').addEventListener('click', () => this.signOut());
      }

      translateAuthError(msg) {
        const map = {
          'Invalid login credentials': 'Email ou mot de passe incorrect',
          'Email not confirmed': 'Email non confirmé, vérifiez votre boîte mail',
          'User already registered': 'Cet email est déjà utilisé',
          'Password should be at least 6 characters': 'Le mot de passe doit faire au moins 6 caractères',
          'Unable to validate email address: invalid format': 'Format d\'email invalide',
          'Email rate limit exceeded': 'Trop de tentatives, réessayez plus tard',
          'For security purposes, you can only request this once every 60 seconds': 'Attendez 60 secondes avant de réessayer',
        };
        return map[msg] || msg;
      }

      // ── Supabase sync ──────────────────────────────────────────

      taskToRow(t) {
        return {
          id: t.id,
          user_id: this.user.id,
          text: t.text,
          completed: t.completed,
          comment: t.comment || '',
          due_date: t.dueDate || null,
          reminded: t.reminded,
          created_at: new Date(t.id).toISOString()
        };
      }

      rowToTask(r) {
        let dd = r.due_date || null;
        if (dd && dd.includes('T')) dd = dd.split('T')[0];
        if (dd && !/^\d{4}-\d{2}-\d{2}$/.test(dd)) dd = null;
        return {
          id: Number(r.id),
          text: (r.text || '').slice(0, 300),
          completed: !!r.completed,
          comment: (r.comment || '').slice(0, 1000),
          dueDate: dd,
          reminded: !!r.reminded
        };
      }

      async loadFromSupabase() {
        if (!_supabase || !this.user) return;
        try {
          const { data, error } = await _supabase
            .from('todos')
            .select('*')
            .eq('user_id', this.user.id)
            .order('created_at', { ascending: false });
          if (error) { console.error('loadFromSupabase', error); return; }
          this.tasks = data.map(r => this.rowToTask(r));
          this.saveLocal();
        } catch(e) { console.error('loadFromSupabase', e); }
      }

      async saveToSupabase(task) {
        if (!_supabase || !this.user) return;
        try {
          const { error } = await _supabase
            .from('todos')
            .upsert(this.taskToRow(task), { onConflict: 'id' });
          if (error) console.error('saveToSupabase', error);
        } catch(e) { console.error('saveToSupabase', e); }
      }

      async deleteFromSupabase(id) {
        if (!_supabase || !this.user) return;
        try {
          const { error } = await _supabase
            .from('todos')
            .delete()
            .eq('id', id)
            .eq('user_id', this.user.id);
          if (error) console.error('deleteFromSupabase', error);
        } catch(e) { console.error('deleteFromSupabase', e); }
      }

      async bulkDeleteFromSupabase(ids) {
        if (!_supabase || !this.user || !ids.length) return;
        try {
          const { error } = await _supabase
            .from('todos')
            .delete()
            .in('id', ids)
            .eq('user_id', this.user.id);
          if (error) console.error('bulkDeleteFromSupabase', error);
        } catch(e) { console.error('bulkDeleteFromSupabase', e); }
      }

      async syncOnLogin() {
        if (!_supabase || !this.user) return;
        // Get existing cloud task IDs
        try {
          const { data: existing } = await _supabase
            .from('todos')
            .select('id')
            .eq('user_id', this.user.id);
          const cloudIds = new Set((existing || []).map(r => Number(r.id)));
          // Push local tasks not yet in cloud
          const toUpload = this.tasks.filter(t => !cloudIds.has(t.id));
          if (toUpload.length) {
            const rows = toUpload.map(t => this.taskToRow(t));
            const { error } = await _supabase.from('todos').upsert(rows, { onConflict: 'id' });
            if (error) console.error('syncOnLogin upsert', error);
          }
        } catch(e) { console.error('syncOnLogin', e); }
      }

      // ── localStorage ───────────────────────────────────────────

      loadLocal() {
        try {
          const raw = JSON.parse(localStorage.getItem('todos'));
          if (!Array.isArray(raw)) return [];
          return raw.filter(t => t && typeof t.id === 'number').map(t => {
            let dd = (typeof t.dueDate === 'string') ? t.dueDate : null;
            if (dd && dd.includes('T')) dd = dd.split('T')[0];
            if (dd && !/^\d{4}-\d{2}-\d{2}$/.test(dd)) dd = null;
            return {
              id: Number(t.id),
              text: (typeof t.text === 'string' ? t.text : '').slice(0, 300),
              completed: !!t.completed,
              comment: (typeof t.comment === 'string' ? t.comment : '').slice(0, 1000),
              dueDate: dd,
              reminded: !!t.reminded
            };
          });
        } catch(e) { return []; }
      }

      saveLocal() {
        try {
          localStorage.setItem('todos', JSON.stringify(this.tasks));
        } catch(e) {
          this.showToast('Erreur de sauvegarde', 'Stockage plein ou indisponible');
        }
      }

      // Unified save: localStorage + async Supabase
      save() {
        this.saveLocal();
      }

      // Periodically scan all date inputs and save their values
      saveAllDates() {
        let changed = false;
        const tasksToSync = [];
        document.querySelectorAll('.task-item').forEach(el => {
          const id = Number(el.dataset.id);
          const input = el.querySelector('.date-input');
          if (!input) return;
          const val = input.value || null;
          const t = this.tasks.find(x => x.id === id);
          if (t && t.dueDate !== val) {
            t.dueDate = val;
            t.reminded = false;
            changed = true;
            tasksToSync.push(t);
            this.updateBadgeFor(el, t);
          }
        });
        if (changed) {
          this.save();
          tasksToSync.forEach(t => this.saveToSupabase(t));
        }
      }

      // Update or create badge for a specific task element
      updateBadgeFor(el, t) {
        const actions = el.querySelector('.task-actions');
        const oldBadge = actions.querySelector('.due-badge');
        if (oldBadge) oldBadge.remove();
        if (t.dueDate) {
          const cls = this.getDueClass(t.dueDate);
          const span = document.createElement('span');
          span.className = 'due-badge ' + cls;
          span.innerHTML = this.clockSvg + '<span class="due-label">' + this.esc(this.formatDue(t.dueDate)) + '</span>';
          actions.insertBefore(span, actions.firstChild);
        }
      }

      bind() {
        this.el('btnAdd').addEventListener('click', () => this.addTask());
        this.el('taskInput').addEventListener('keydown', e => { if (e.key === 'Enter') this.addTask(); });
        this.el('btnClear').addEventListener('click', () => this.clearCompleted());
        this.el('btnExport').addEventListener('click', () => this.exportTasks());
        this.el('btnImport').addEventListener('click', () => this.el('fileImport').click());
        this.el('fileImport').addEventListener('change', e => this.importTasks(e));
        this.el('btnTheme').addEventListener('click', () => {
          const n = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', n);
          localStorage.setItem('theme', n);
        });
      }

      exportTasks() {
        this.saveAllDates();
        const data = JSON.stringify(this.tasks, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'todo-backup-' + new Date().toISOString().slice(0, 10) + '.json';
        a.click();
        URL.revokeObjectURL(url);
        this.showToast('Export réussi', this.tasks.length + ' tâche(s) exportée(s)');
      }

      importTasks(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const raw = JSON.parse(reader.result);
            if (!Array.isArray(raw)) throw new Error('Format invalide');
            const imported = raw.filter(t => t && typeof t.id === 'number' && typeof t.text === 'string').map(t => {
              let dd = (typeof t.dueDate === 'string') ? t.dueDate : null;
              if (dd && dd.includes('T')) dd = dd.split('T')[0];
              if (dd && !/^\d{4}-\d{2}-\d{2}$/.test(dd)) dd = null;
              return {
                id: Number(t.id), text: t.text.slice(0, 300), completed: !!t.completed,
                comment: (typeof t.comment === 'string' ? t.comment : '').slice(0, 1000),
                dueDate: dd, reminded: !!t.reminded
              };
            });
            if (!imported.length) { this.showToast('Import échoué', 'Aucune tâche valide trouvée'); return; }
            this.tasks = imported;
            this.save();
            this.render();
            this.showToast('Import réussi', imported.length + ' tâche(s) importée(s)');
            // Sync all imported tasks to Supabase
            if (this.user) {
              imported.forEach(t => this.saveToSupabase(t));
            }
          } catch(err) {
            this.showToast('Import échoué', 'Fichier JSON invalide');
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      }

      addTask() {
        const text = this.el('taskInput').value.trim();
        if (!text) return;
        this.saveAllDates();
        const task = { id: Date.now(), text, completed: false, comment: '', dueDate: null, reminded: false };
        this.tasks.unshift(task);
        this.el('taskInput').value = '';
        this.el('taskInput').focus();
        this.save();
        this.render();
        this.saveToSupabase(task);
      }

      toggleTask(id) {
        this.saveAllDates();
        const t = this.tasks.find(x => x.id === id);
        if (!t) return;
        t.completed = !t.completed;
        this.save();
        this.saveToSupabase(t);
        const el = document.querySelector(`[data-id="${id}"]`);
        if (el) {
          el.classList.toggle('completed', t.completed);
          el.classList.add('completing');
          el.addEventListener('animationend', () => el.classList.remove('completing'), { once: true });
        }
        this.updateCounter();
      }

      deleteTask(id) {
        this.saveAllDates();
        const el = document.querySelector(`[data-id="${id}"]`);
        if (!el) return;
        el.classList.add('removing');
        el.addEventListener('animationend', () => {
          this.tasks = this.tasks.filter(t => t.id !== id);
          this.save();
          this.render();
          this.deleteFromSupabase(id);
        }, { once: true });
      }

      toggleComment(id) {
        const s = document.querySelector(`[data-id="${id}"] .comment-section`);
        if (!s) return;
        s.classList.toggle('open');
        if (s.classList.contains('open')) s.querySelector('textarea').focus();
      }

      updateComment(id, v) {
        const t = this.tasks.find(x => x.id === id);
        if (!t) return;
        t.comment = v;
        this.save();
        const b = document.querySelector(`[data-id="${id}"] .btn-comment`);
        if (b) b.classList.toggle('active', v.trim().length > 0);
        // Debounced Supabase sync (1s)
        clearTimeout(this._commentTimers[id]);
        this._commentTimers[id] = setTimeout(() => this.saveToSupabase(t), 1000);
      }

      getDueClass(d) {
        if (!d) return '';
        const parts = d.split('-');
        const due = new Date(parts[0], parts[1] - 1, parts[2]);
        const now = new Date(); now.setHours(0, 0, 0, 0);
        const days = Math.round((due - now) / 864e5);
        if (days < 0) return 'due-red overdue';
        if (days < 5) return 'due-red';
        if (days < 15) return 'due-yellow';
        return 'due-green';
      }

      formatDue(d) {
        const parts = d.split('-');
        const due = new Date(parts[0], parts[1] - 1, parts[2]);
        const now = new Date(); now.setHours(0, 0, 0, 0);
        const diffDays = Math.round((due - now) / 864e5);
        const dateStr = due.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        if (diffDays < 0) return 'En retard ' + Math.abs(diffDays) + 'j';
        if (diffDays === 0) return "Aujourd'hui";
        if (diffDays === 1) return 'Demain';
        if (diffDays <= 7) return dateStr + ' (' + diffDays + 'j)';
        return dateStr;
      }

      initReminders() {
        if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
        this.checkReminders();
        setInterval(() => this.checkReminders(), 30000);
        setInterval(() => this.refreshBadges(), 60000);
      }

      checkReminders() {
        const now = new Date(); now.setHours(0, 0, 0, 0);
        this.tasks.forEach(t => {
          if (!t.dueDate || t.completed || t.reminded) return;
          const parts = t.dueDate.split('-');
          const due = new Date(parts[0], parts[1] - 1, parts[2]);
          const days = Math.round((due - now) / 864e5);
          if (days <= 1) {
            t.reminded = true;
            this.save();
            const title = days < 0 ? 'Tâche en retard !' : 'Rappel de tâche';
            this.showToast(title, t.text);
            if ('Notification' in window && Notification.permission === 'granted')
              new Notification(title, { body: t.text });
          }
        });
      }

      refreshBadges() {
        document.querySelectorAll('.task-item').forEach(el => {
          const t = this.tasks.find(x => x.id === Number(el.dataset.id));
          if (!t || !t.dueDate) return;
          this.updateBadgeFor(el, t);
        });
      }

      showToast(title, msg) {
        const t = document.createElement('div'); t.className = 'toast';
        t.innerHTML = '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><div class="toast-body"><div class="toast-title">' + this.esc(title) + '</div><div class="toast-msg">' + this.esc(msg) + '</div></div><button class="toast-close">&times;</button>';
        this.el('toastContainer').appendChild(t);
        const dismiss = () => { if (!t.classList.contains('removing')) { t.classList.add('removing'); t.addEventListener('animationend', () => t.remove(), { once: true }); } };
        t.querySelector('.toast-close').addEventListener('click', dismiss);
        setTimeout(dismiss, 8000);
      }

      clearCompleted() {
        this.saveAllDates();
        const els = document.querySelectorAll('.task-item.completed');
        if (!els.length) return;
        const completedIds = this.tasks.filter(t => t.completed).map(t => t.id);
        let n = els.length;
        els.forEach(el => {
          el.classList.add('removing');
          el.addEventListener('animationend', () => {
            if (--n === 0) {
              this.tasks = this.tasks.filter(t => !t.completed);
              this.save();
              this.render();
              this.bulkDeleteFromSupabase(completedIds);
            }
          }, { once: true });
        });
      }

      render() {
        const list = this.el('taskList');
        const footer = this.el('footer');

        // Don't show app content if not authenticated/skipped
        if (!this.user && !this._skipped) return;

        if (!this.tasks.length) {
          list.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg><p>Aucune tâche pour le moment</p></div>';
          footer.style.display = 'none';
          return;
        }

        footer.style.display = 'flex';

        list.innerHTML = this.tasks.map(t => {
          const cls = this.getDueClass(t.dueDate);
          const badge = t.dueDate
            ? '<span class="due-badge ' + cls + '">' + this.clockSvg + '<span class="due-label">' + this.esc(this.formatDue(t.dueDate)) + '</span></span>'
            : '';

          const safeId = Number(t.id);
          const safeDate = t.dueDate ? this.esc(t.dueDate) : '';

          return '<div class="task-item ' + (t.completed ? 'completed' : '') + '" data-id="' + safeId + '">'
            + '<div class="task-row">'
            + '<label class="checkbox-wrapper"><input type="checkbox" ' + (t.completed ? 'checked' : '') + '><div class="checkmark"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div></label>'
            + '<div class="task-content"><span class="task-text">' + this.esc(t.text) + '</span></div>'
            + '<div class="task-actions">'
            + badge
            + '<input type="date" class="date-input" value="' + safeDate + '">'
            + '<button class="btn-action btn-comment ' + (t.comment ? 'active' : '') + '" title="Commenter"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></button>'
            + '<button class="btn-action btn-delete" title="Supprimer"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg></button>'
            + '</div>'
            + '</div>'
            + '<div class="comment-section ' + (t.comment ? 'open' : '') + '"><div class="comment-inner"><textarea placeholder="Ajouter un commentaire..." maxlength="1000">' + this.esc(t.comment) + '</textarea></div></div>'
            + '</div>';
        }).join('');

        // Bind events
        list.querySelectorAll('.task-item').forEach(el => {
          const id = Number(el.dataset.id);
          el.querySelector('input[type="checkbox"]').addEventListener('change', () => this.toggleTask(id));
          el.querySelector('.btn-delete').addEventListener('click', () => this.deleteTask(id));
          el.querySelector('.btn-comment').addEventListener('click', () => this.toggleComment(id));
          el.querySelector('textarea').addEventListener('input', e => this.updateComment(id, e.target.value));

          const dateInput = el.querySelector('.date-input');
          const handleDate = () => {
            const val = dateInput.value || null;
            const t = this.tasks.find(x => x.id === id);
            if (!t) return;
            if (t.dueDate !== val) {
              t.dueDate = val;
              t.reminded = false;
              this.save();
              this.updateBadgeFor(el, t);
              this.saveToSupabase(t);
            }
          };
          dateInput.addEventListener('change', handleDate);
          dateInput.addEventListener('input', handleDate);
          dateInput.addEventListener('blur', handleDate);
        });

        this.updateCounter();
      }

      updateCounter() {
        const r = this.tasks.filter(t => !t.completed).length;
        this.el('counter').innerHTML = '<strong>' + r + '</strong> tâche' + (r !== 1 ? 's' : '') + ' restante' + (r !== 1 ? 's' : '') + ' sur ' + this.tasks.length;
      }

      esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    }

    document.addEventListener('DOMContentLoaded', () => new TodoApp());
  </script>
</body>
</html>
